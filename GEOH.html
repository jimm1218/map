<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å°ä¸­è¥¿å±¯å•†åœˆ POI åœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border: 1px solid #999;
      font-size: 14px;
      z-index: 999;
    }
    .slider-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border: 1px solid #999;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend">
    <b>ğŸ“Œ é¡åˆ¥é¡è‰²èªªæ˜</b><br />
    <span style="color:orange;">ğŸŸ§ é¤é£²</span><br />
    <span style="color:purple;">ğŸŸª ç™¾è²¨</span><br />
    <span style="color:green;">ğŸŸ© åœè»Šå ´</span><br />
    <span style="color:blue;">ğŸŸ¦ å•†è¾¦</span><br />
    <span style="color:red;">ğŸŸ¥ ä¾¿åˆ©å•†åº—</span>
  </div>

  <div class="slider-box">
    <label for="radiusSlider"
      >ğŸ“ æŸ¥è©¢åŠå¾‘ (å…¬å°º): <span id="radiusValue">1200</span></label
    ><br />
    <input
      type="range"
      min="100"
      max="3000"
      step="100"
      value="1200"
      id="radiusSlider"
    />
  </div>

  <script>
    // é è¨­å€¼
    let center = [24.1736, 120.6095];
    let radius = 1200;

    // é¡å‹èˆ‡é¡è‰²å°æ‡‰
    const colorMap = {
      é¤é£²: "orange",
      ç™¾è²¨: "purple",
      åœè»Šå ´: "green",
      å•†è¾¦: "blue",
      ä¾¿åˆ©å•†åº—: "red",
    };

    let poisGeo = null;

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map("map").setView(center, 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    // æ‹–æ›³ä¸­å¿ƒé»æ¨™è¨˜
    const centerMarker = L.marker(center, { draggable: true })
      .addTo(map)
      .bindPopup("æ‹–æ›³æˆ‘æ”¹è®Šä¸­å¿ƒé»")
      .openPopup();

    // åˆå§‹åŒ–åœ“å½¢Buffer
    let circle = L.circle(center, {
      radius: radius,
      color: "red",
      fillOpacity: 0.1,
    }).addTo(map);

    // POIåœ–å±¤ç¾¤çµ„
    let poiLayer = L.layerGroup().addTo(map);

    // æ›´æ–° POI èˆ‡åœ“å½¢ç¯„åœ
    function updatePOIs() {
      if (!poisGeo) {
        console.log("poisGeo å°šæœªè¼‰å…¥");
        return;
      }

      poiLayer.clearLayers();

      // ç¢ºä¿ center æ˜¯ LatLng ç‰©ä»¶
      const centerPoint = L.latLng(center[0], center[1]);

      // æ›´æ–°åœ“å½¢ä½ç½®èˆ‡åŠå¾‘
      circle.setLatLng(centerPoint);
      circle.setRadius(radius);

      console.log("ä¸­å¿ƒé»ï¼š", centerPoint.toString(), "åŠå¾‘ï¼š", radius);
      console.log("ç¸½POIæ•¸ï¼š", poisGeo.features.length);

      let countInRadius = 0;

      poisGeo.features.forEach((f) => {
        if (!f.geometry || !f.geometry.coordinates) return;

        // GeoJSON æ ¼å¼æ˜¯ [ç¶“åº¦, ç·¯åº¦]
        const [lon, lat] = f.geometry.coordinates;
        const d = centerPoint.distanceTo(L.latLng(lat, lon));

        if (d <= radius) {
          countInRadius++;

          const type = f.properties.type;
          const name = f.properties.name || "ç„¡åç¨±";
          const addr = f.properties.address || "ç„¡åœ°å€";
          const color = colorMap[type] || "gray";

          const marker = L.circleMarker([lat, lon], {
            radius: 6,
            color: color,
            fillColor: color,
            fillOpacity: 0.8,
          }).bindPopup(`<b>${name}</b><br>${type}<br>${addr}`);

          poiLayer.addLayer(marker);
        }
      });

      console.log("ç¯„åœå…§ POI æ•¸é‡ï¼š", countInRadius);
    }

    // è¼‰å…¥ pois.geojson
    fetch("pois.geojson")
      .then((res) => res.json())
      .then((data) => {
        poisGeo = data;
        updatePOIs();
      })
      .catch((err) => {
        console.error("è¼‰å…¥ pois.geojson å¤±æ•—:", err);
      });

    // æ‹–æ›³ä¸­å¿ƒé»å¾Œæ›´æ–°ä¸¦åŒæ­¥åœ°åœ–è¦–è§’
    centerMarker.on("dragend", function (e) {
      center = [e.target.getLatLng().lat, e.target.getLatLng().lng];
      map.setView(center);
      updatePOIs();
    });

    // èª¿æ•´æ»‘æ¡¿å¾Œæ›´æ–°
    document.getElementById("radiusSlider").addEventListener("input", function () {
      radius = parseInt(this.value);
      document.getElementById("radiusValue").innerText = radius;
      updatePOIs();
    });
  </script>
</body>
</html>

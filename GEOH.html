<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å°ä¸­è¥¿å±¯å•†åœˆ POI åœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .legend, .slider-box, .search-box, .results-box {
      position: fixed;
      background: white;
      padding: 10px;
      border: 1px solid #999;
      z-index: 999;
      font-size: 14px;
    }
    .legend { bottom: 20px; left: 20px; }
    .slider-box { top: 20px; left: 20px; }
    .search-box { top: 20px; right: 20px; }
    .results-box { top: 100px; right: 20px; max-height: 200px; overflow-y: auto; width: 200px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend">
    <b>ğŸ“Œ é¡åˆ¥é¡è‰²èªªæ˜</b><br />
    <span style="color:orange;">ğŸŸ§ é¤é£²</span><br />
    <span style="color:purple;">ğŸŸª ç™¾è²¨</span><br />
    <span style="color:green;">ğŸŸ© åœè»Šå ´</span><br />
    <span style="color:blue;">ğŸŸ¦ å•†è¾¦</span><br />
    <span style="color:red;">ğŸŸ¥ ä¾¿åˆ©å•†åº—</span><br />
    <span style="color:black; background:yellow; padding:1px 4px;">ğŸ”¥ ç«é‹/ç‡’è‚‰</span>
  </div>

  <div class="slider-box">
    <label for="radiusSlider">ğŸ“ æŸ¥è©¢åŠå¾‘ (å…¬å°º): <span id="radiusValue">1200</span></label><br />
    <input type="range" min="100" max="3000" step="100" value="1200" id="radiusSlider" />
  </div>

  <div class="search-box">
    ğŸ” æœå°‹é—œéµå­—ï¼š<br />
    <input type="text" id="searchInput" placeholder="ä¾‹å¦‚ï¼šç«é‹" />
    <button onclick="searchPOIs()">æœå°‹</button>
  </div>

  <div class="results-box">
    <b>ğŸ“‹ æœå°‹çµæœ</b>
    <ul id="resultList"></ul>
  </div>

  <script>
    let center = [24.1736, 120.6095];
    let radius = 1200;
    const colorMap = {
      é¤é£²: "orange",
      ç™¾è²¨: "purple",
      åœè»Šå ´: "green",
      å•†è¾¦: "blue",
      ä¾¿åˆ©å•†åº—: "red"
    };

    let poisGeo = null;
    const map = L.map("map").setView(center, 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const centerMarker = L.marker(center, { draggable: true }).addTo(map)
      .bindPopup("æ‹–æ›³æˆ‘æ”¹è®Šä¸­å¿ƒé»").openPopup();

    let circle = L.circle(center, { radius: radius, color: "red", fillOpacity: 0.1 }).addTo(map);
    let poiLayer = L.layerGroup().addTo(map);
    let searchLayer = L.layerGroup().addTo(map); // é¡å¤–æœå°‹åœ–å±¤

    function updatePOIs() {
      if (!poisGeo) return;
      poiLayer.clearLayers();
      const centerPoint = L.latLng(center[0], center[1]);
      circle.setLatLng(centerPoint);
      circle.setRadius(radius);

      poisGeo.features.forEach(f => {
        if (!f.geometry) return;
        const [lon, lat] = f.geometry.coordinates;
        const d = centerPoint.distanceTo([lat, lon]);
        if (d <= radius) {
          const type = f.properties.type;
          const name = f.properties.name || "ç„¡åç¨±";
          const addr = f.properties.address || "ç„¡åœ°å€";
          const color = colorMap[type] || "gray";

          const marker = L.circleMarker([lat, lon], {
            radius: 6, color, fillColor: color, fillOpacity: 0.8
          }).bindPopup(`<b>${name}</b><br>${type}<br>${addr}`);
          poiLayer.addLayer(marker);
        }
      });
    }

    // æœå°‹åŠŸèƒ½
    function searchPOIs() {
      const keyword = document.getElementById("searchInput").value.trim();
      const centerPoint = L.latLng(center[0], center[1]);
      const resultList = document.getElementById("resultList");
      resultList.innerHTML = "";
      searchLayer.clearLayers();

      if (!keyword || !poisGeo) return;

      const resultNames = new Set();

      poisGeo.features.forEach(f => {
        if (!f.geometry || !f.properties) return;
        const [lon, lat] = f.geometry.coordinates;
        const d = centerPoint.distanceTo([lat, lon]);

        const name = f.properties.name || "";
        const addr = f.properties.address || "";
        const fulltext = name + " " + addr;

        if (d <= radius && fulltext.includes(keyword)) {
          resultNames.add(name);
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            color: "black",
            fillColor: "yellow",
            fillOpacity: 0.9
          }).bindPopup(`<b>${name}</b><br>${addr}<br>(é—œéµå­—å‘½ä¸­)`);
          searchLayer.addLayer(marker);
        }
      });

      if (resultNames.size === 0) {
        resultList.innerHTML = "<li>âŒ æ‰¾ä¸åˆ°ç¬¦åˆé …ç›®</li>";
      } else {
        [...resultNames].forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          resultList.appendChild(li);
        });
      }
    }

    // è¼‰å…¥è³‡æ–™
    fetch("pois.geojson")
      .then(res => res.json())
      .then(data => {
        poisGeo = data;
        updatePOIs();
      })
      .catch(err => console.error("è¼‰å…¥å¤±æ•—:", err));

    centerMarker.on("dragend", e => {
      center = [e.target.getLatLng().lat, e.target.getLatLng().lng];
      map.setView(center);
      updatePOIs();
    });

    document.getElementById("radiusSlider").addEventListener("input", function () {
      radius = parseInt(this.value);
      document.getElementById("radiusValue").innerText = radius;
      updatePOIs();
    });
  </script>
</body>
</html>
